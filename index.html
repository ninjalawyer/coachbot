<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanctuary - Personal Wellness Companion</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --cream: #faf7f2;
            --warm-white: #ffffff;
            --sage: #9ca998;
            --deep-sage: #6b7b65;
            --charcoal: #2d2d2d;
            --gold: #d4af37;
            --shadow: rgba(45, 45, 45, 0.08);
            --shadow-heavy: rgba(45, 45, 45, 0.15);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #f5f2ed 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--charcoal);
            line-height: 1.6;
        }

        .app-container {
            background: var(--warm-white);
            border-radius: 0;
            box-shadow: 0 40px 80px var(--shadow-heavy), 0 20px 40px var(--shadow);
            width: 100%;
            max-width: 480px;
            height: 85vh;
            max-height: 700px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .app-header {
            background: var(--warm-white);
            padding: 40px 32px 24px;
            border-bottom: 1px solid rgba(156, 169, 152, 0.15);
            position: relative;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
        }

        .app-title {
            font-size: 28px;
            font-weight: 300;
            color: var(--charcoal);
            text-align: center;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .app-subtitle {
            font-size: 14px;
            color: var(--sage);
            text-align: center;
            font-weight: 400;
            opacity: 0.8;
        }

        .api-setup-button {
            background: transparent;
            color: var(--sage);
            border: 1px solid rgba(156, 169, 152, 0.3);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            margin: 8px auto 0;
            display: block;
            transition: all 0.3s ease;
            font-weight: 400;
        }

        .api-setup-button:hover {
            border-color: var(--sage);
            color: var(--deep-sage);
            background: rgba(156, 169, 152, 0.05);
        }

        .api-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(45, 45, 45, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .api-modal-content {
            background: var(--warm-white);
            border-radius: 16px;
            padding: 32px;
            max-width: 480px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 40px 80px var(--shadow-heavy);
            position: relative;
        }

        .api-modal h3 {
            font-size: 20px;
            font-weight: 500;
            color: var(--charcoal);
            margin-bottom: 16px;
            text-align: center;
        }

        .api-modal p {
            font-size: 14px;
            color: var(--sage);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .api-input-group {
            margin-bottom: 20px;
        }

        .api-input-group label {
            display: block;
            font-size: 13px;
            color: var(--deep-sage);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .api-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(156, 169, 152, 0.3);
            border-radius: 8px;
            font-size: 14px;
            color: var(--charcoal);
            background: var(--warm-white);
            font-family: 'Monaco', 'Menlo', monospace;
            transition: border-color 0.3s ease;
        }

        .api-input:focus {
            outline: none;
            border-color: var(--sage);
        }

        .api-input::placeholder {
            color: var(--sage);
            opacity: 0.6;
        }

        .api-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .api-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-weight: 500;
        }

        .api-button.primary {
            background: var(--charcoal);
            color: var(--warm-white);
        }

        .api-button.primary:hover {
            background: var(--deep-sage);
        }

        .api-button.secondary {
            background: transparent;
            color: var(--sage);
            border: 1px solid rgba(156, 169, 152, 0.3);
        }

        .api-button.secondary:hover {
            border-color: var(--sage);
            color: var(--deep-sage);
        }

        .api-link {
            color: var(--gold);
            text-decoration: none;
            font-weight: 500;
        }

        .api-link:hover {
            text-decoration: underline;
        }

        .api-steps {
            background: rgba(156, 169, 152, 0.05);
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            font-size: 13px;
            line-height: 1.5;
        }

        .api-steps ol {
            margin-left: 16px;
        }

        .api-steps li {
            margin-bottom: 8px;
        }

        .conversation-area {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            background: var(--warm-white);
            position: relative;
        }

        .conversation-area::-webkit-scrollbar {
            width: 2px;
        }

        .conversation-area::-webkit-scrollbar-track {
            background: transparent;
        }

        .conversation-area::-webkit-scrollbar-thumb {
            background: var(--sage);
            border-radius: 2px;
        }

        .message {
            margin: 0;
            padding: 24px 32px;
            border-bottom: 1px solid rgba(156, 169, 152, 0.08);
            animation: messageSlide 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes messageSlide {
            from { 
                opacity: 0; 
                transform: translateY(20px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }

        .message.assistant {
            background: linear-gradient(135deg, #fafafa 0%, var(--warm-white) 100%);
        }

        .message.user {
            background: var(--warm-white);
            text-align: right;
        }

        .message-content {
            font-size: 16px;
            line-height: 1.7;
            font-weight: 400;
            max-width: none;
        }

        .message.assistant .message-content {
            color: var(--charcoal);
        }

        .message.user .message-content {
            color: var(--deep-sage);
            font-weight: 500;
        }

        .input-section {
            padding: 32px;
            background: var(--warm-white);
            border-top: 1px solid rgba(156, 169, 152, 0.15);
            position: relative;
        }

        .input-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 32px;
            right: 32px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--sage), transparent);
            opacity: 0.3;
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 16px;
        }

        .input-field {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 16px;
            color: var(--charcoal);
            placeholder-color: var(--sage);
            padding: 0;
            resize: none;
            outline: none;
            font-family: inherit;
            line-height: 1.5;
            min-height: 24px;
            max-height: 120px;
        }

        .input-field::placeholder {
            color: var(--sage);
            font-weight: 400;
        }

        .send-button {
            background: var(--charcoal);
            color: var(--warm-white);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 16px;
            flex-shrink: 0;
        }

        .send-button:hover {
            background: var(--deep-sage);
            transform: scale(1.05);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .quick-prompts {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .quick-prompts::-webkit-scrollbar {
            height: 2px;
        }

        .quick-prompts::-webkit-scrollbar-track {
            background: transparent;
        }

        .quick-prompts::-webkit-scrollbar-thumb {
            background: var(--sage);
            border-radius: 2px;
        }

        .quick-prompt {
            background: transparent;
            color: var(--sage);
            border: 1px solid rgba(156, 169, 152, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            font-weight: 400;
        }

        .quick-prompt:hover {
            border-color: var(--sage);
            color: var(--deep-sage);
            background: rgba(156, 169, 152, 0.05);
        }

        .status-indicator {
            position: fixed;
            top: 24px;
            right: 24px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--sage);
            box-shadow: 0 8px 32px var(--shadow);
            z-index: 1000;
            font-weight: 500;
        }

        .thinking-indicator {
            display: none;
            padding: 24px 32px;
            color: var(--sage);
            font-style: italic;
            font-size: 14px;
            background: linear-gradient(135deg, #fafafa 0%, var(--warm-white) 100%);
            border-bottom: 1px solid rgba(156, 169, 152, 0.08);
        }

        .thinking-dots {
            display: inline-flex;
            gap: 4px;
            margin-left: 8px;
        }

        .thinking-dot {
            width: 4px;
            height: 4px;
            background: var(--sage);
            border-radius: 50%;
            animation: thinking 1.8s infinite ease-in-out;
        }

        .thinking-dot:nth-child(2) { animation-delay: 0.3s; }
        .thinking-dot:nth-child(3) { animation-delay: 0.6s; }

        @keyframes thinking {
            0%, 80%, 100% { 
                opacity: 0.3;
                transform: scale(0.8);
            }
            40% { 
                opacity: 1;
                transform: scale(1);
            }
        }

        .welcome-message {
            padding: 40px 32px;
            text-align: center;
            color: var(--sage);
            background: linear-gradient(135deg, #fafafa 0%, var(--warm-white) 100%);
            border-bottom: 1px solid rgba(156, 169, 152, 0.08);
        }

        .welcome-message h2 {
            font-size: 18px;
            font-weight: 500;
            color: var(--charcoal);
            margin-bottom: 12px;
            letter-spacing: 0.3px;
        }

        .welcome-message p {
            font-size: 14px;
            line-height: 1.6;
            opacity: 0.8;
            margin-bottom: 16px;
        }

        .privacy-notice {
            font-size: 11px;
            color: var(--sage);
            opacity: 0.6;
            line-height: 1.4;
            margin-top: 20px;
        }

        .crisis-notice {
            background: rgba(212, 175, 55, 0.08);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            padding: 16px;
            margin: 20px 32px;
            font-size: 12px;
            color: var(--charcoal);
            text-align: center;
            line-height: 1.5;
        }

        .crisis-notice strong {
            color: var(--gold);
            font-weight: 600;
        }

        .floating-orbs {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            pointer-events: none;
            z-index: -1;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(212, 175, 55, 0.8), rgba(156, 169, 152, 0.4));
            animation: float 15s infinite linear;
        }

        .orb:nth-child(1) {
            width: 100px;
            height: 100px;
            top: 20%;
            left: -50px;
            animation-delay: 0s;
        }

        .orb:nth-child(2) {
            width: 140px;
            height: 140px;
            top: 60%;
            left: -70px;
            animation-delay: -5s;
        }

        .orb:nth-child(3) {
            width: 80px;
            height: 80px;
            top: 40%;
            left: -40px;
            animation-delay: -10s;
        }

        @keyframes float {
            0% {
                transform: translateX(0) translateY(0);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateX(calc(100vw + 200px)) translateY(-100px);
                opacity: 0;
            }
        }

        .breathing-glow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(212, 175, 55, 0.8) 50%, 
                transparent 100%);
            animation: breathe 4s ease-in-out infinite;
            z-index: 10;
        }

        @keyframes breathe {
            0%, 100% {
                opacity: 0.6;
                transform: scaleX(0.5);
            }
            50% {
                opacity: 1;
                transform: scaleX(1.5);
            }
        }

        .app-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(212, 175, 55, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(156, 169, 152, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(212, 175, 55, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
            animation: pulse 10s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.7;
            }
            50% {
                opacity: 1;
            }
        }

        .message {
            margin: 0;
            padding: 24px 32px;
            border-bottom: 1px solid rgba(156, 169, 152, 0.08);
            animation: messageSlide 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .message::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.1), transparent);
            animation: shimmer 2s ease-in-out;
            animation-delay: 0.5s;
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        .app-header,
        .conversation-area,
        .input-section {
            position: relative;
            z-index: 1;
        }

        @media (max-width: 768px) {
            .app-container {
                height: 100vh;
                max-height: none;
                border-radius: 0;
            }
            
            .app-header {
                padding: 32px 24px 20px;
            }
            
            .message {
                padding: 20px 24px;
            }
            
            .input-section {
                padding: 24px;
            }
            
            .status-indicator {
                top: 16px;
                right: 16px;
            }

            .api-modal-content {
                padding: 24px;
                margin: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="floating-orbs">
            <div class="orb"></div>
            <div class="orb"></div>
            <div class="orb"></div>
        </div>
        
        <div class="breathing-glow"></div>
        
        <div class="app-header">
            <h1 class="app-title">Sanctuary</h1>
            <p class="app-subtitle">Personal wellness companion • Beta</p>
            <button class="api-setup-button" onclick="openApiModal()">⚡ Enable AI Mode</button>
        </div>
        
        <div class="conversation-area" id="conversationArea">
            <div class="welcome-message">
                <h2>Welcome to your space</h2>
                <p>I'm here to listen without judgment and help you navigate whatever you're experiencing. What's on your mind today?</p>
                
                <div class="privacy-notice">
                    Currently in therapeutic mode. Enable AI mode above for enhanced conversations. No personal information is collected, and conversations aren't permanently stored.
                </div>
            </div>
            
            <div class="crisis-notice">
                <strong>Important:</strong> This is a wellness companion, not a replacement for professional care. If you're experiencing suicidal thoughts or a mental health crisis, please contact a counselor or call 911 immediately.
            </div>
            
            <div class="thinking-indicator" id="thinkingIndicator">
                Reflecting on your words
                <div class="thinking-dots">
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                </div>
            </div>
        </div>
        
        <div class="input-section">
            <div class="quick-prompts">
                <button class="quick-prompt" onclick="useQuickPrompt('I\'ve been feeling anxious lately')">Feeling anxious</button>
                <button class="quick-prompt" onclick="useQuickPrompt('I had a difficult day')">Difficult day</button>
                <button class="quick-prompt" onclick="useQuickPrompt('I feel overwhelmed')">Overwhelmed</button>
                <button class="quick-prompt" onclick="useQuickPrompt('I need some perspective')">Need perspective</button>
            </div>
            
            <div class="input-container">
                <textarea 
                    id="messageInput" 
                    class="input-field" 
                    placeholder="Share what's on your mind..."
                    rows="1"
                    maxlength="500"
                ></textarea>
                <button class="send-button" onclick="sendMessage()" id="sendButton">
                    →
                </button>
            </div>
        </div>
    </div>

    <div class="status-indicator" id="statusIndicator">
        Therapeutic Mode
    </div>

    <!-- API Setup Modal -->
    <div class="api-modal" id="apiModal">
        <div class="api-modal-content">
            <h3>Enable AI-Enhanced Conversations</h3>
            <p>To unlock AI-powered responses, you'll need a free Hugging Face API key. This enables more nuanced and contextual conversations while keeping your data private.</p>
            
            <div class="api-steps">
                <strong>How to get your free API key:</strong>
                <ol>
                    <li>Visit <a href="https://huggingface.co/join" target="_blank" class="api-link">huggingface.co/join</a> and create a free account</li>
                    <li>Go to your <a href="https://huggingface.co/settings/tokens" target="_blank" class="api-link">Settings → Access Tokens</a></li>
                    <li>Click "New token", give it a name like "Sanctuary", and select "Read" access</li>
                    <li>Copy the token that starts with "hf_" and paste it below</li>
                </ol>
            </div>

            <div class="api-input-group">
                <label for="apiKeyInput">Hugging Face API Key:</label>
                <input 
                    type="password" 
                    id="apiKeyInput" 
                    class="api-input" 
                    placeholder="hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                    maxlength="100"
                >
            </div>

            <p style="font-size: 12px; color: var(--sage); margin-bottom: 0;">
                Your API key is stored locally in your browser and never sent to our servers. It's only used to communicate directly with Hugging Face for AI responses.
            </p>

            <div class="api-buttons">
                <button class="api-button secondary" onclick="closeApiModal()">Cancel</button>
                <button class="api-button primary" onclick="saveApiKey()">Save & Enable AI</button>
            </div>
        </div>
    </div>

    <script>
        class SanctuaryBot {
            constructor() {
                this.conversationHistory = [];
                this.sessionMessages = 0;
                this.apiKey = this.loadApiKey();
                this.apiCallCount = parseInt(sessionStorage.getItem('sanctuaryApiCalls') || '0');
                this.maxDailyApiCalls = 50;
                this.lastApiReset = sessionStorage.getItem('sanctuaryApiReset') || new Date().toDateString();
                
                // Reset API counter if new day
                if (this.lastApiReset !== new Date().toDateString()) {
                    this.apiCallCount = 0;
                    this.lastApiReset = new Date().toDateString();
                    sessionStorage.setItem('sanctuaryApiCalls', '0');
                    sessionStorage.setItem('sanctuaryApiReset', this.lastApiReset);
                }
                
                // Hugging Face API configuration - using better model
                this.apiUrl = 'https://api-inference.huggingface.co/models/microsoft/DialoGPT-large';
                
                // Therapeutic context for AI responses
                this.therapeuticContext = `You are Sanctuary, a sophisticated mental health companion. Respond with:
                - Deep empathy and validation
                - Evidence-based insights from psychology
                - Thoughtful follow-up questions
                - Practical, gentle guidance
                - Professional warmth without being clinical
                Keep responses conversational, insightful, and under 120 words.
                
                Context: `;
                
                // Curated therapeutic responses for fallback
                this.therapeuticPatterns = {
                    anxiety: {
                        triggers: ['anxious', 'worry', 'nervous', 'panic', 'stressed', 'overwhelmed'],
                        responses: [
                            "Anxiety often signals that something matters deeply to you. What specifically is weighing on your mind right now?",
                            "I hear the worry in your words. Sometimes our minds create stories about the future. What evidence do you have that challenges your most feared outcome?",
                            "Anxiety can feel all-consuming, but you've navigated difficult feelings before. What has helped ground you in the past?"
                        ]
                    },
                    sadness: {
                        triggers: ['sad', 'depressed', 'down', 'hurt', 'empty', 'hopeless', 'crying'],
                        responses: [
                            "Your pain is real and valid. Sadness often reflects how much something mattered to you. What are you grieving right now?",
                            "It takes courage to sit with difficult emotions. What would you need to feel even slightly more supported in this moment?",
                            "Sometimes sadness is how we honor what we've lost or what we hoped for. What story is your sadness trying to tell you?"
                        ]
                    },
                    anger: {
                        triggers: ['angry', 'furious', 'frustrated', 'irritated', 'mad', 'rage'],
                        responses: [
                            "Anger often protects something vulnerable underneath. What boundary or value feels threatened right now?",
                            "That frustration sounds intense. What would it look like to honor that feeling while also caring for yourself?",
                            "Your anger is information. What is it trying to tell you about what you need or what matters to you?"
                        ]
                    },
                    relationships: {
                        triggers: ['relationship', 'partner', 'friend', 'family', 'conflict', 'fight', 'hurt by'],
                        responses: [
                            "Relationships can hold our deepest joys and most profound hurts. What are you hoping for in this situation?",
                            "It sounds like this relationship means something significant to you. What would healing look like here?",
                            "Human connection is complex. What do you think the other person might not understand about your experience?"
                        ]
                    }
                };
                
                this.updateStatusIndicator();
            }

            loadApiKey() {
                // Try to load from localStorage (persistent) first, then sessionStorage
                return localStorage.getItem('sanctuaryApiKey') || sessionStorage.getItem('sanctuaryApiKey') || null;
            }

            saveApiKey(key, persistent = false) {
                this.apiKey = key;
                if (persistent) {
                    localStorage.setItem('sanctuaryApiKey', key);
                } else {
                    sessionStorage.setItem('sanctuaryApiKey', key);
                }
                this.updateStatusIndicator();
            }

            hasApiKey() {
                return this.apiKey && this.apiKey.startsWith('hf_');
            }
            
            async generateResponse(userMessage) {
                this.conversationHistory.push({ role: 'user', content: userMessage });
                this.sessionMessages++;
                
                // Try AI response if API key is available and within limits
                if (this.hasApiKey() && this.apiCallCount < this.maxDailyApiCalls) {
                    try {
                        const aiResponse = await this.getAIResponse(userMessage);
                        if (aiResponse) {
                            this.apiCallCount++;
                            sessionStorage.setItem('sanctuaryApiCalls', this.apiCallCount.toString());
                            this.updateStatusIndicator();
                            return aiResponse;
                        }
                    } catch (error) {
                        console.log('AI response failed, using therapeutic fallback');
                    }
                }
                
                // Fallback to therapeutic patterns
                return this.getTherapeuticResponse(userMessage);
            }
            
            async getAIResponse(userMessage) {
                if (!this.hasApiKey()) {
                    console.log('No API key available');
                    return null;
                }

                console.log('Making API call to Hugging Face...');
                console.log('API calls used:', this.apiCallCount, '/', this.maxDailyApiCalls);
                
                try {
                    // Build a more focused prompt for better responses
                    const therapeuticPrompt = `You are a compassionate mental health companion named Sanctuary. The user shared: "${userMessage}". Respond with empathy, validation, and helpful insight in 1-2 sentences, then ask a thoughtful follow-up question. Keep it under 100 words and conversational.

Response:`;

                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKey}`,
                            'Content-Type': 'application/json',
                            'User-Agent': 'Sanctuary-App/1.0'
                        },
                        body: JSON.stringify({
                            inputs: therapeuticPrompt,
                            parameters: {
                                max_new_tokens: 80,
                                temperature: 0.7,
                                do_sample: true,
                                top_p: 0.9,
                                repetition_penalty: 1.2,
                                return_full_text: false
                            },
                            options: {
                                wait_for_model: true,
                                use_cache: false
                            }
                        })
                    });
                    
                    console.log('API Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error Response:', errorText);
                        
                        if (response.status === 503) {
                            console.log('Model loading, will retry...');
                            // Model is loading, wait and retry once
                            await new Promise(resolve => setTimeout(resolve, 5000));
                            return await this.retryAPICall(therapeuticPrompt);
                        }
                        
                        throw new Error(`API Error: ${response.status} - ${errorText}`);
                    }
                    
                    const data = await response.json();
                    console.log('Full API Response:', JSON.stringify(data, null, 2));
                    
                    if (data && Array.isArray(data) && data.length > 0) {
                        const result = data[0];
                        if (result.generated_text) {
                            let aiResponse = result.generated_text.trim();
                            
                            // Clean up the response
                            aiResponse = this.cleanAIResponse(aiResponse, userMessage);
                            
                            if (aiResponse && aiResponse.length > 10) {
                                console.log('Successfully got AI response:', aiResponse);
                                return aiResponse;
                            }
                        }
                    }
                    
                    console.log('No valid generated text in response');
                    return null;
                    
                } catch (error) {
                    console.error('AI API error:', error);
                    return null;
                }
            }

            async retryAPICall(prompt) {
                try {
                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            inputs: prompt,
                            parameters: {
                                max_new_tokens: 80,
                                temperature: 0.7,
                                do_sample: true,
                                top_p: 0.9,
                                return_full_text: false
                            }
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data && data[0] && data[0].generated_text) {
                            return this.cleanAIResponse(data[0].generated_text.trim());
                        }
                    }
                } catch (error) {
                    console.error('Retry API call failed:', error);
                }
                return null;
            }

            cleanAIResponse(response, userMessage = '') {
                if (!response) return null;
                
                // Remove any prompt repetition
                let cleaned = response.replace(/You are a compassionate.*?Response:\s*/g, '');
                
                // Remove user message if it was repeated
                if (userMessage) {
                    cleaned = cleaned.replace(new RegExp(userMessage, 'gi'), '').trim();
                }
                
                // Remove common artifacts
                cleaned = cleaned.replace(/^(Response:|Answer:|Reply:)\s*/i, '');
                cleaned = cleaned.replace(/\[.*?\]/g, ''); // Remove bracketed content
                cleaned = cleaned.replace(/^\W+/, ''); // Remove leading non-word chars
                
                // Ensure it's a reasonable length
                if (cleaned.length < 10 || cleaned.length > 300) {
                    return null;
                }
                
                // Make sure it ends properly
                if (!cleaned.match(/[.!?]$/)) {
                    if (cleaned.length > 80) {
                        cleaned += '...';
                    } else {
                        cleaned += '.';
                    }
                }
                
                return cleaned.trim();
            }
            
            buildConversationContext(currentMessage) {
                const recentContext = this.conversationHistory
                    .slice(-2)
                    .map(m => m.content)
                    .join(' ');
                return this.therapeuticContext + recentContext + '\n\nUser: ';
            }
            
            refineAIResponse(rawResponse) {
                let response = rawResponse.trim();
                
                // Ensure appropriate length
                if (response.length > 200) {
                    response = response.substring(0, 200) + '...';
                }
                
                // Add therapeutic elements if missing
                if (!response.includes('?') && Math.random() > 0.6) {
                    const therapeuticQuestions = [
                        " What feels most important about this to you?",
                        " How are you taking care of yourself through this?",
                        " What would self-compassion look like here?",
                        " What support do you have available?"
                    ];
                    response += therapeuticQuestions[Math.floor(Math.random() * therapeuticQuestions.length)];
                }
                
                return response;
            }
            
            getTherapeuticResponse(userMessage) {
                const message = userMessage.toLowerCase();
                
                // Find matching therapeutic pattern
                for (const [category, pattern] of Object.entries(this.therapeuticPatterns)) {
                    const hasMatch = pattern.triggers.some(trigger => message.includes(trigger));
                    if (hasMatch) {
                        const responses = pattern.responses;
                        return responses[Math.floor(Math.random() * responses.length)];
                    }
                }
                
                // Generic therapeutic responses
                const genericResponses = [
                    "I'm here with you in this moment. What feels most present for you right now?",
                    "Thank you for trusting me with this. What would it mean to you to feel heard about this?",
                    "Your experience matters. What's the most difficult part of what you're going through?",
                    "I sense this is weighing on you. What kind of support would feel most helpful right now?",
                    "There's wisdom in what you're feeling. What is your inner voice telling you about this situation?"
                ];
                
                return genericResponses[Math.floor(Math.random() * genericResponses.length)];
            }
            
            updateStatusIndicator() {
                const indicator = document.getElementById('statusIndicator');
                
                if (!this.hasApiKey()) {
                    indicator.textContent = 'Therapeutic Mode';
                    return;
                }
                
                const remaining = this.maxDailyApiCalls - this.apiCallCount;
                
                if (remaining > 10) {
                    indicator.textContent = 'AI-Enhanced Mode';
                } else if (remaining > 0) {
                    indicator.textContent = `AI Mode (${remaining} left today)`;
                } else {
                    indicator.textContent = 'Therapeutic Mode';
                }
            }
        }

        // Initialize Sanctuary
        const sanctuary = new SanctuaryBot();

        // API Modal Functions
        function openApiModal() {
            document.getElementById('apiModal').style.display = 'flex';
            document.getElementById('apiKeyInput').focus();
        }

        function closeApiModal() {
            document.getElementById('apiModal').style.display = 'none';
            document.getElementById('apiKeyInput').value = '';
        }

        function saveApiKey() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                alert('Please enter your Hugging Face API key.');
                return;
            }
            
            if (!apiKey.startsWith('hf_')) {
                alert('Invalid API key format. Hugging Face API keys start with "hf_"');
                return;
            }
            
            // Test the API key first
            testApiKey(apiKey).then(isValid => {
                if (isValid) {
                    // Save API key (session storage for privacy by default)
                    sanctuary.saveApiKey(apiKey, false);
                    closeApiModal();
                    
                    // Update welcome message
                    const welcomeMessage = document.querySelector('.welcome-message .privacy-notice');
                    welcomeMessage.textContent = 'AI mode enabled! Enhanced conversations with secure processing through Hugging Face. No personal information is collected, and conversations aren\'t permanently stored.';
                    
                    // Show success message
                    addMessage("✨ AI mode is now enabled! I can provide more nuanced and contextual responses. How are you feeling today?", false);
                } else {
                    alert('Unable to connect with this API key. Please check that it\'s correct and has the right permissions.');
                }
            }).catch(error => {
                console.error('API key test failed:', error);
                alert('Error testing API key. Please try again.');
            });
        }

        async function testApiKey(apiKey) {
            try {
                const response = await fetch('https://api-inference.huggingface.co/models/microsoft/DialoGPT-large', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inputs: "Hello",
                        parameters: { max_new_tokens: 10 }
                    })
                });
                
                // Even if the model is loading (503), the API key is valid
                return response.status === 200 || response.status === 503;
            } catch (error) {
                console.error('API key test error:', error);
                return false;
            }
        }

        // Close modal when clicking outside
        document.getElementById('apiModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeApiModal();
            }
        });

        // Handle Enter key in API input
        document.getElementById('apiKeyInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                saveApiKey();
            }
        });

        function addMessage(content, isUser = false) {
            const conversationArea = document.getElementById('conversationArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(contentDiv);
            conversationArea.appendChild(messageDiv);
            
            // Smooth scroll to bottom
            conversationArea.scrollTo({
                top: conversationArea.scrollHeight,
                behavior: 'smooth'
            });
        }

        function showThinking() {
            document.getElementById('thinkingIndicator').style.display = 'block';
        }

        function hideThinking() {
            document.getElementById('thinkingIndicator').style.display = 'none';
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, true);
            input.value = '';
            input.style.height = 'auto';
            
            // Show thinking state
            showThinking();
            
            try {
                // Generate response with realistic delay
                const response = await sanctuary.generateResponse(message);
                
                // Simulate thoughtful processing time
                await new Promise(resolve => setTimeout(resolve, 1200 + Math.random() * 800));
                
                hideThinking();
                addMessage(response);
                
            } catch (error) {
                hideThinking();
                addMessage("I'm having trouble processing that right now. Could you try rephrasing your thoughts?");
                console.error('Response generation error:', error);
            }
        }

        function useQuickPrompt(prompt) {
            document.getElementById('messageInput').value = prompt;
            sendMessage();
        }

        // Auto-resize textarea
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Send on Enter (but allow Shift+Enter for new lines)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Focus input on load
        window.addEventListener('load', () => {
            messageInput.focus();
            
            setTimeout(() => {
                console.log('Sanctuary initialized');
                console.log('API Key present:', sanctuary.hasApiKey() ? 'Yes' : 'No');
                console.log('API calls used today:', sanctuary.apiCallCount);
                
                // Show initial setup hint if no API key
                if (!sanctuary.hasApiKey()) {
                    console.log('Tip: Click "Enable AI Mode" to enhance conversations with your free Hugging Face API key');
                }
            }, 1500);
        });
    </script>
</body>
</html>
